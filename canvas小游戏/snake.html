<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>snake</title>
</head>
<body>
    <canvas id="screen" width="800" height="600" style="background-color: darkslategray">
         当前浏览器不支持canvas
    </canvas>
</body>
<script>
class Food {
    constructor (size, color, ctx) {
        this.radius = size;
        this.color = color;
        this.x = Math.floor(Math.random() * 196) * 4;
        this.y = Math.floor(Math.random() * 146) * 4;
        this.x === 0 ? 4 : this.x;
        this.y === 0 ? 4 : this.y;
    }

    drawFood(ctx) {
        ctx.save();
        ctx.fillStyle = this.color;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2, false);
        ctx.closePath();
        ctx.fill();
        ctx.restore();
    }
}

class SnakeBlock {
    constructor (size, color, x, y) {
        this.color = color;
        this.size = size;
        this.x = x;
        this.y = y;
    }

    drawBlock(ctx) {
        ctx.save();
        ctx.fillStyle = this.color;
        ctx.beginPath();
        ctx.rect(this.x, this.y, this.size, this.size);
        ctx.closePath();
        ctx.fill();
        ctx.restore();
    }
}

class Snake {
    constructor (size, color) {
        this.color = color;
        this.size = size;
        this.headx = Math.floor(Math.random() * 196) * 4 + 2;
        this.heady = Math.floor(Math.random() * 146) * 4 + 2;
        this.headx === 0 ? 2 : this.headx;
        this.heady === 0 ? 2 : this.heady;
        this.snakeLen = 0;
        this.snakeBlocks = [];
        this.dir = 'up';
    }

    addBody(ctx) {
        if (this.snakeLen === 0) {
            let snakeBlock = new SnakeBlock(this.size, this.color, this.headx, this.heady);
            this.snakeBlocks.push(snakeBlock);
        } else {
            if (this.snakeBlocks.length > 0) {
                let x = 0;
                let y = 0;
                switch (this.dir) {
                    case 'up':
                        x = this.snakeBlocks[0].x;
                        y = this.snakeBlocks[0].y - this.size;
                        break;
                    case 'down':
                        x = this.snakeBlocks[0].x;
                        y = this.snakeBlocks[0].y + this.size;
                        break;
                    case 'left':
                        x = this.snakeBlocks[0].x - this.size;
                        y = this.snakeBlocks[0].y;
                        break;
                    case 'right':
                        x = this.snakeBlocks[0].x + this.size;
                        y = this.snakeBlocks[0].y;
                        break;
                    default:
                        break;
                }

                let snakeBlock = new SnakeBlock(this.size, this.color, x, y);
                this.snakeBlocks.unshift(snakeBlock);
            }
        }
        this.snakeLen ++;
    }

    move(ctx) {
        let tempArr = [];
        for (let i = this.snakeBlocks.length - 1; i >= 0; i--) {
            if (i === 0) {
                let x = 0;
                let y = 0;
                switch (this.dir) {
                    case 'up':
                        x = this.snakeBlocks[0].x;
                        y = this.snakeBlocks[0].y - this.size;
                        break;
                    case 'down':
                        x = this.snakeBlocks[0].x;
                        y = this.snakeBlocks[0].y + this.size;
                        break;
                    case 'left':
                        x = this.snakeBlocks[0].x - this.size;
                        y = this.snakeBlocks[0].y;
                        break;
                    case 'right':
                        x = this.snakeBlocks[0].x + this.size;
                        y = this.snakeBlocks[0].y;
                        break;
                    default:
                        break;
                }
                this.snakeBlocks[0].x = x;
                this.snakeBlocks[0].y = y;
            } else {
                this.snakeBlocks[i].x = this.snakeBlocks[i - 1].x;
                this.snakeBlocks[i].y = this.snakeBlocks[i - 1].y;
            }
        }
    }

    drawSnake(ctx) {
        for (let i = 0; i < this.snakeBlocks.length; i++) {
            let snakeBlock = this.snakeBlocks[i];
            snakeBlock.drawBlock(ctx);
        }
    }

    checkIsDead(ctx) {
        let firstSnakeBlock = this.snakeBlocks[0];
        if (firstSnakeBlock.x < 0 || firstSnakeBlock.x > 800 || firstSnakeBlock.y < 0 || firstSnakeBlock.y > 600) {
            return true;
        }

        if (this.snakeLen > 1) {
            for (let i = 1; i < this.snakeBlocks.length; i++) {
                let snakeBlock = this.snakeBlocks[i];

                if ((Math.abs(firstSnakeBlock.x - snakeBlock.x) < this.size && firstSnakeBlock.x !== snakeBlock.x)|| (Math.abs(firstSnakeBlock.y - snakeBlock.y) < this.size && firstSnakeBlock.y !== snakeBlock.y)) {
                    return true;
                }
            }
        }

        return false;
    }
}

function checkFood(food, snake) {
    let snakeHead = snake.snakeBlocks[0];
    if ((food.x >= snakeHead.x) && (food.x <= snakeHead.x + snake.size) && (food.y >= snakeHead.y) && (food.y <= snakeHead.y + snake.size)) {
        return false; // 被吃
    } else {
        return true;
    }
}

window.onload = function () {
    let canvas = document.getElementById('screen');
    let ctx = canvas.getContext('2d');

    let snake = new Snake(8, '#0f8e33');
    snake.addBody(ctx);

    let food = new Food(4, 'red');

    (function drawFrame() {
        // setTimeout(() => {
        //     drawFrame();
        // }, 1000);
        window.requestAnimationFrame(drawFrame);
        ctx.clearRect(0, 0, 800, 600);

        snake.drawSnake(ctx);
        food.drawFood(ctx);
    }());

    document.onkeydown = function (e) {
        switch (e.keyCode) {
            // up
            case 38:
                if (snake.snakeLen > 1) {
                    if (snake.dir === 'left' || snake.dir === 'right') {
                        snake.dir = 'up';
                    }
                } else {
                    snake.dir = 'up';
                }
                break;
            // down
            case 40:
                if (snake.snakeLen > 1) {
                    if (snake.dir === 'left' || snake.dir === 'right') {
                        snake.dir = 'down';
                    }
                } else {
                    snake.dir = 'down';
                }
                break;
            // left
            case 37:
                if (snake.snakeLen > 1) {
                    if (snake.dir === 'up' || snake.dir === 'down') {
                        snake.dir = 'left';
                    }
                } else {
                    snake.dir = 'left';
                }
                break;
            // right
            case 39:
                if (snake.snakeLen > 1) {
                    if (snake.dir === 'up' || snake.dir === 'down') {
                        snake.dir = 'right';
                    }
                } else {
                    snake.dir = 'right';
                }
                break;
            default:
                break;
        }
        let hasFood = checkFood(food, snake);
        if (!hasFood) {
            food = new Food(4, 'red');
            food.drawFood(ctx);
            snake.addBody(ctx);
        } else {
            snake.move(ctx);
        }

        let isDead = snake.checkIsDead(ctx);
        if (isDead) {
            alert('dead');
        }
    }
};
</script>
</html>